{% extends "predeterminados/base.html"%}
{% load static %}
{% block titulo%} Crear Proyecto {%endblock%}
{% block estilos%}
<link rel="stylesheet" type="text/css" href="{% static 'css/stylesform.css' %}" />
{%endblock%}
{% block contenido%}
<main class="main ">
    <form method="post" class="form-style">
        <div class="container-form">
            {% csrf_token %}
            <div class="row">
                <div class="column">
                    <label for="id_cliente">Cliente:</label>
                    <input type="text" id="id_cliente"
                        value="{{ form.instance.cliente.first_name }} {{ form.instance.cliente.last_name }}" readonly>
                    <label for="id_nombre">Nombre:</label>
                    {{ form.nombre }}
                </div>
                <div class="column">
                    <label for="id_notas_personales">Notas Personales:</label>
                    {{ form.notas_personales }}
                </div>
            </div>
        </div>
        <div class="row unity-row">
            <img id="streamImage" alt="Streaming Image" />

            <script>
                const socket = new WebSocket('ws://localhost:8000/ws/jsonScene/');

                socket.onopen = function (event) {
                    console.log('WebSocket connection established');

                    // Suscribirse al grupo de clientes web
                    socket.send(JSON.stringify({
                        'command': 'subscribe',
                        'group': 'web_clients_group',
                    }));
                };

                socket.onmessage = function (event) {
                    console.log('Received data from server');

                    if (event.data instanceof Blob) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            const arrayBuffer = this.result;
                            const blob = new Blob([new Uint8Array(arrayBuffer)], { type: 'image/jpeg' });
                            const url = URL.createObjectURL(blob);

                            const img = document.getElementById('streamImage');
                            img.src = url;
                        };
                        reader.readAsArrayBuffer(event.data);
                    } else {
                        console.log('Received non-binary data:', event.data);
                    }
                };

                socket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                };

                socket.onclose = function (event) {
                    console.log('WebSocket connection closed:', event.code, event.reason);
                };

                // Function to convert ArrayBuffer to base64 URL
                function arrayBufferToBase64(buffer) {
                    let binary = '';
                    const bytes = new Uint8Array(buffer);
                    const len = bytes.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return 'data:image/jpeg;base64,' + btoa(binary);
                }
            </script>
            <!-- Contenido para la segunda fila, que se integra con Unity -->
        </div>
        <div class="row buttons-container">
            <button class="button-arounder" type="submit">Guardar</button>
        </div>
    </form>
</main>
{%endblock%}